{% extends 'base_generic.html' %}
{% load static %}

{% block content %}
<div class="container-login">
    <h2>Редагування профілю</h2>

    <!-- Форма редагування імені та email -->
    <form method="post" class="form-reg" style="margin-bottom: 35px;" id="profile-form">
        {% csrf_token %}
        {{ profile_form.non_field_errors }}
        <label for="id_username">Ім'я:</label>
        {{ profile_form.username }}
        <label for="id_email">Email:</label>
        {{ profile_form.email }}
        <button type="submit" name="save_profile" class="sub-btn">Зберегти зміни</button>
    </form>

    <hr style="margin: 35px 0; border: 1px solid #efcd64;">

    <!-- Форма зміни пароля -->
    <form method="post" class="form-reg" id="password-form" novalidate>
        {% csrf_token %}
        {{ password_form.non_field_errors }}
        <label for="id_old_password">Старий пароль:</label>
        {{ password_form.old_password }}

        <label for="id_new_password1">Новий пароль:</label>
        <input type="password" name="new_password1" id="id_new_password1" class="form-control no-copy-paste" required>
        <ul id="password-checklist" class="text-muted" style="font-size:0.95em; margin-bottom:0; margin-top:4px; padding-left:18px;">
            <li id="len-check">Мінімум 8 символів</li>
            <li id="upper-check">Хоча б одна велика літера</li>
            <li id="spec-check">Хоча б один спецсимвол (!@#$%^&*)</li>
        </ul>

        <label for="id_new_password2">Підтвердіть новий пароль:</label>
        <input type="password" name="new_password2" id="id_new_password2" class="form-control no-copy-paste" required>
        <span id="match-check" class="text-muted" style="font-size:0.95em; display:block;"></span>
        <button type="submit" name="change_password" class="sub-btn" id="change-password-btn">Змінити пароль</button>
    </form>
</div>

<script>
// JS для заборони копіювання/вставки у парольних полях
(function() {
    const passFields = document.querySelectorAll(".no-copy-paste");
    passFields.forEach(field => {
        field.setAttribute('autocomplete', 'new-password'); // без автозаповнення
        field.setAttribute('oncopy', 'return false');
        field.setAttribute('onpaste', 'return false');
        field.setAttribute('oncut', 'return false');
        field.addEventListener('copy', e => e.preventDefault());
        field.addEventListener('paste', e => e.preventDefault());
        field.addEventListener('cut', e => e.preventDefault());
        field.addEventListener('contextmenu', e => e.preventDefault());
    });
})();

// Live-валідація пароля
(function() {
    const passwordInput = document.getElementById("id_new_password1");
    const confirmInput = document.getElementById("id_new_password2");
    const submitBtn = document.getElementById("change-password-btn");
    const lenCheck = document.getElementById("len-check");
    const upperCheck = document.getElementById("upper-check");
    const specCheck = document.getElementById("spec-check");
    const matchCheck = document.getElementById("match-check");

    function checkPassword() {
        const value = passwordInput.value || "";
        let valid = true;

        // Довжина
        if (value.length >= 8) {
            lenCheck.style.color = "green";
        } else {
            lenCheck.style.color = "red";
            valid = false;
        }

        // Велика літера
        if (/[A-ZА-ЯЁЇЄІ]/.test(value)) {
            upperCheck.style.color = "green";
        } else {
            upperCheck.style.color = "red";
            valid = false;
        }

        // Спецсимвол
        if (/[!@#$%^&*]/.test(value)) {
            specCheck.style.color = "green";
        } else {
            specCheck.style.color = "red";
            valid = false;
        }

        submitBtn.disabled = !valid || !passwordsMatch();
    }

    function passwordsMatch() {
        const password = passwordInput.value || "";
        const confirm = confirmInput.value || "";
        if (!confirm) {
            matchCheck.textContent = "";
            return false;
        }
        if (password === confirm) {
            matchCheck.textContent = "Паролі співпадають";
            matchCheck.style.color = "green";
            return true;
        } else {
            matchCheck.textContent = "Паролі не співпадають";
            matchCheck.style.color = "red";
            return false;
        }
    }

    if (passwordInput && confirmInput && submitBtn) {
        passwordInput.addEventListener("input", function() {
            checkPassword();
            passwordsMatch();
        });

        confirmInput.addEventListener("input", function() {
            passwordsMatch();
            checkPassword();
        });

        document.addEventListener("DOMContentLoaded", function() {
            submitBtn.disabled = true;
        });
    }
})();
</script>
{% endblock %}
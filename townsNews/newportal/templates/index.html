<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

{% extends 'base_generic.html' %}

{% block content %}

    <div class="table-container">
        <h1>ОСТАННІ, НАЙЦІКАВІШІ НОВИНИ</h1>
        <p>Ми публікуємо останні новини які є актуальними та перевіреними</p>
        <h3>Тренд тижня</h3>
        {% if one_article_block.one_article_block.image %}
            <div class="news-item block-crimea"
                 style="background-image: url('{{ one_article_block.one_article_block.image.url }}');"
                 data-url="{% url 'article-detail' one_article_block.one_article_block.pk %}">
                <!-- велике прев’ю: при 36px максимум 4 слова -->
                <div class="overlay-text js-truncate" data-base-words="45" data-max-at-36="4">
                    {{ one_article_block.one_article_block.article_text }}
                </div>
            </div>
        {% else %}
            <div class="news-item block-crimea"
                 style="background-image: url('/static/default.jpg');"
                 data-url="">
                <div class="overlay-text js-truncate" data-base-words="45" data-max-at-36="4">
                    {{ one_article_block.one_article_block.article_text }}
                </div>
            </div>
        {% endif %}
    </div>

    <div class="block-three">
        <ul>
            {% for article in three_articles_block.three_articles_block %}
            <li class="news-item" data-url="{% url 'article-detail' article.pk %}">
                <div>
                    {% if article.image %}
                        <img src="{{ article.image.url }}" alt="{{ article.title }}">
                    {% endif %}
                    <p class="date">{{ article.date_of_publication|date:"d.m.Y" }}</p>
                    <!-- мале прев’ю: при 36px максимум 1 слово -->
                    <p class="text js-truncate" data-base-words="10" data-max-at-36="1">
                        {{ article.article_text }}
                    </p>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div class="block-three2">
        <ul>
            {% for article in three_articles_block.three_articles_block %}
            <li class="news-item" data-url="{% url 'article-detail' article.pk %}">
                <div>
                    {% if article.image %}
                        <img src="{{ article.image.url }}" alt="{{ article.title }}">
                    {% endif %}
                    <p class="date">{{ article.date_of_publication|date:"d.m.Y" }}</p>
                    <p class="text js-truncate" data-base-words="10" data-max-at-36="1">
                        {{ article.article_text }}
                    </p>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div class="news-item block-crimea2"
         style="background-image: url('{{ one_article_block.one_article_block.image.url }}');"
         data-url="{% url 'article-detail' one_article_block.one_article_block.pk %}">
        <div class="overlay-text js-truncate" data-base-words="45" data-max-at-36="4">
            {{ one_article_block.one_article_block.article_text }}
        </div>
    </div>

    <div class="block-two">
        <table>
            <tr>
                {% for article in two_articles_block.two_articles_block %}
                <td class="news-item" data-url="{% url 'article-detail' article.pk %}" style="vertical-align:top;">
                    {% if article.image %}
                        <img src="{{ article.image.url }}" alt="{{ article.title }}">
                    {% endif %}
                    <p class="date">{{ article.date_of_publication|date:"d.m.Y" }}</p>
                    <!-- дві колонки — теж вважаємо «малими» -->
                    <p class="text js-truncate" data-base-words="10" data-max-at-36="1">
                        {{ article.article_text }}
                    </p>
                </td>
                {% endfor %}
            </tr>
        </table>
    </div>

    <div class="block-six">
        <div class="block1">
            <ul>
                {% if six_articles_block %}
                    {% for article in six_articles_block %}
                    <li class="news-item" data-url="{% url 'article-detail' article.pk %}">
                        <div>
                            {% if article.image %}
                                <img src="{{ article.image.url }}" alt="{{ article.title }}">
                            {% endif %}
                            <p class="date">{{ article.date_of_publication|date:"d.m.Y" }}</p>
                            <p class="text js-truncate" data-base-words="10" data-max-at-36="1">
                                {{ article.article_text }}
                            </p>
                        </div>
                    </li>
                    {% endfor %}
                {% else %}
                    <li><p>Немає статей для відображення.</p></li>
                {% endif %}
            </ul>
        </div>
        <div class="block2">
            <ul>
                {% if six_articles_block2 %}
                    {% for article in six_articles_block2 %}
                    <li class="news-item" data-url="{% url 'article-detail' article.pk %}">
                        <div>
                            {% if article.image %}
                                <img src="{{ article.image.url }}" alt="{{ article.title }}">
                            {% endif %}
                            <p class="date">{{ article.date_of_publication|date:"d.m.Y" }}</p>
                            <p class="text js-truncate" data-base-words="10" data-max-at-36="1">
                                {{ article.article_text }}
                            </p>
                        </div>
                    </li>
                    {% endfor %}
                {% else %}
                    <li><p>Немає статей для відображення.</p></li>
                {% endif %}
            </ul>
        </div>
    </div>

    <script>
        // Клік по плитці
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.news-item[data-url]').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    if (e.target.tagName.toLowerCase() === 'a') return;
                    const url = this.getAttribute('data-url');
                    if (url) window.location.href = url;
                });
            });
        });
    </script>

    <!-- ДИНАМІЧНЕ ОГРАНИЧЕННЯ СЛІВ + ЖОРСТКІ ЛІМІТИ ДЛЯ 36px -->
    <script>
    (function() {
      const BASE_FONT = 14;
      const GLOBAL_SENSITIVITY = 2.6; // базова агресивність
      const MIN_WORDS = 1;            // тепер мінімум 1 слово дозволений

      function primeElements() {
        document.querySelectorAll('.js-truncate').forEach(el => {
          if (!el.dataset.fulltext) {
            el.dataset.fulltext = (el.textContent || '').trim().replace(/\s+/g, ' ');
          }
        });
      }

      function elementFontPx(el) {
        const fs = parseFloat(getComputedStyle(el).fontSize);
        return isNaN(fs) ? BASE_FONT : fs;
      }

      function applyTruncation() {
        document.querySelectorAll('.js-truncate').forEach(el => {
          const base = parseInt(el.dataset.baseWords || '10', 10);
          const sensitivity = parseFloat(el.dataset.sensitivity || GLOBAL_SENSITIVITY);

          const cur = elementFontPx(el);
          let ratio = Math.pow(BASE_FONT / cur, sensitivity);
          let computed = Math.max(MIN_WORDS, Math.min(base, Math.round(base * ratio)));

          // --- ЖОРСТКІ ЛІМІТИ ДЛЯ МАКСИМАЛЬНОГО ШРИФТУ (36px) ---
          // Якщо поточний розмір дуже близький до 36px (±0.5), беремо cap з data-max-at-36
          const capAt36Attr = el.dataset.maxAt36;
          if (cur >= 35.5 && capAt36Attr) {
            const capAt36 = parseInt(capAt36Attr, 10);
            if (!isNaN(capAt36)) computed = Math.max(MIN_WORDS, Math.min(computed, capAt36));
          }
          // -------------------------------------------------------

          const words = (el.dataset.fulltext || '').split(/\s+/);
          if (!words.length) return;

          el.textContent = (words.length <= computed)
            ? words.join(' ')
            : words.slice(0, computed).join(' ') + '…';
        });
      }

      function init() {
        primeElements();
        applyTruncation();
      }

      document.addEventListener('DOMContentLoaded', init);
      window.addEventListener('resize', applyTruncation);
      const mo = new MutationObserver(applyTruncation);
      mo.observe(document.body, { attributes: true, attributeFilter: ['style','class'] });
      window.applyDynamicTruncation = applyTruncation;
    })();
    </script>
{% endblock %}